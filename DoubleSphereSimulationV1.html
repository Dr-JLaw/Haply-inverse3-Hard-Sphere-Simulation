<!DOCTYPE html>
<html>
<head>
  <title>Hard Sphere Simulator (WebSocket) - V2</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    p { font-size: 1.2em; }
    button { padding: 10px 20px; margin: 10px 5px; font-size: 1em; }
  </style>
</head>
<body>
  <h2>Hard Sphere Simulation- V1</h2>
  <button onclick="setAnchor()">üìç Set Center Point (Radius=5cm)</button>
  <button onclick="setAnchor2()">üìç Set Center Point2 (Radius=10cm)</button>
  <button onclick="clearAnchor()">‚ùå Clear All Spheres</button>
  <p id="status">Connecting...</p>
  <p id="position">Position: N/A</p>
  <p id="force">Force Sent: N/A</p>
  <p id="anchor">Sphere 1: N/A</p>
  <p id="anchor">Sphere 2: N/A</p>
  <p id="distance">Distance from Center 1: N/A</p>
  <p id="distance2">Distance from Center 2: N/A</p>
  <p id="restLength">Sphere 1 Diameter: N/A</p>
  <p id="restLength2">Sphere 2 Diameter: N/A</p>


  <script>
    const ws = new WebSocket("ws://localhost:10001");
    let deviceID = null;
    let anchor = null;
    const restLength = 0.05;
    const restLength2 = 0.02;
    const k = 0;
    const k1 = 20*5;
    ws.onopen = () => {
      document.getElementById("status").innerText = "‚úÖ Connected to Inverse3 WebSocket";
    };

    ws.onerror = (err) => {
      document.getElementById("status").innerText = "‚ùå WebSocket Error";
      console.error("WebSocket error:", err);
    };

    ws.onmessage = mainLoop;

    function mainLoop(event) {
      const data = JSON.parse(event.data);
      const device = data.inverse3?.[0];
      if (!device) return;

      deviceID = device.device_id;
      const pos = device.state?.cursor_position;
      if (!pos) return;

      document.getElementById("position").innerText =
        `Position ‚Üí X: ${pos.x.toFixed(3)} | Y: ${pos.y.toFixed(3)} | Z: ${pos.z.toFixed(3)}`;

      let force = { x: 0, y: 0, z: 0 };

      if (anchor) {
        const dx = pos.x - anchor.x;
        const dy = pos.y - anchor.y;
        const dz = pos.z - anchor.z;
        const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);
        document.getElementById("distance").innerText = `Distance from Anchor: ${dist.toFixed(4)} m`;

        if (dist > restLength) {
          const stretch = dist - restLength;
          const direction = { x: dx / dist, y: dy / dist, z: dz / dist };
          force = {
            x: -k * stretch * direction.x,
            y: -k * stretch * direction.y,
            z: -k * stretch * direction.z
          };
        }
        
         if (dist <= restLength) {
          const stretch = dist - restLength;
          const direction = { x: dx / dist, y: dy / dist, z: dz / dist };
          force = {
            x: -k1* stretch * direction.x,
            y: -k1* stretch * direction.y,
            z: -k1* stretch * direction.z
          };
        }
      } else {
        document.getElementById("distance").innerText = "Distance from Anchor: N/A";
      }

      const msg = {
        inverse3: [
          {
            device_id: deviceID,
            commands: { set_cursor_force: { values: force } }
          }
        ]
      };

      ws.send(JSON.stringify(msg));

      document.getElementById("force").innerText =
        `Force Sent ‚Üí X: ${force.x.toFixed(2)} | Y: ${force.y.toFixed(2)} | Z: ${force.z.toFixed(2)}`;
    }



      if (anchor2) {
        const dx2 = pos.x - anchor2.x;
        const dy2 = pos.y - anchor2.y;
        const dz2 = pos.z - anchor2.z;
        const dist2 = Math.sqrt(dx2 * dx2 + dy2 * dy2 + dz2 * dz2);
        document.getElementById("distance2").innerText = `Distance from Sphere2: ${dist.toFixed(4)} m`;

        if (dist2 > restLength2) {
          const stretch2 = dist2 - restLength2;
          const direction2 = { x: dx2 / dist2, y: dy2 / dist2, z: dz2 / dist2 };
          force = {
            x: -k * stretch2 * direction2.x,
            y: -k * stretch2 * direction2.y,
            z: -k * stretch2 * direction2.z
          };
        }
        
         if (dist2 <= restLength2) {
          const stretch2 = dist2 - restLength2;
          const direction2 = { x: dx2 / dist2, y: dy2 / dist2, z: dz2 / dist2 };
          force = {
            x: -k1* stretch2 * direction2.x,
            y: -k1* stretch2 * direction2.y,
            z: -k1* stretch2 * direction2.z
          };
        }
      } else {
        document.getElementById("distance2").innerText = "Distance from Sphere2: N/A";
      }

      const msg = {
        inverse3: [
          {
            device_id: deviceID,
            commands: { set_cursor_force: { values: force } }
          }
        ]
      };
      
      
      
      ws.send(JSON.stringify(msg));

      document.getElementById("force").innerText =
        `Force Sent ‚Üí X: ${force.x.toFixed(2)} | Y: ${force.y.toFixed(2)} | Z: ${force.z.toFixed(2)}`;
    }

    function setAnchor() {
      document.getElementById("status").innerText = "üîÑ Recording anchor...";
      // Temporarily add one-time listener
      const handler = (event) => {
        const data = JSON.parse(event.data);
        const device = data.inverse3?.[0];
        if (!device) return;
        anchor = device.state?.cursor_position;
        document.getElementById("anchor").innerText =
          `Anchor ‚Üí X: ${anchor.x.toFixed(3)} | Y: ${anchor.y.toFixed(3)} | Z: ${anchor.z.toFixed(3)}`;
        document.getElementById("status").innerText = "‚úÖ Anchor Set";
        ws.removeEventListener("message", handler); // Restore main loop
      };
      ws.addEventListener("message", handler);
    }
    
    function setAnchor2() {
      document.getElementById("status").innerText = "üîÑ Recording anchor...";
      // Temporarily add one-time listener
      const handler = (event) => {
        const data = JSON.parse(event.data);
        const device = data.inverse3?.[0];
        if (!device) return;
        anchor2 = device.state?.cursor_position;
        document.getElementById("anchor2").innerText =
          `Anchor ‚Üí X: ${anchor2.x.toFixed(3)} | Y: ${anchor2.y.toFixed(3)} | Z: ${anchor2.z.toFixed(3)}`;
        document.getElementById("status").innerText = "‚úÖ Anchor2 Set";
        ws.removeEventListener("message", handler); // Restore main loop
      };
      ws.addEventListener("message", handler);
    }

    function clearAnchor() {
      anchor = null;
      document.getElementById("anchor").innerText = "Anchor: N/A";
      document.getElementById("status").innerText = "Anchor cleared.";
    }
  </script>
</body>
</html>

